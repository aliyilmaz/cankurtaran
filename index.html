<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="google" content="notranslate">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="author" content="aliyilmaz">
  <meta name="description" content="To protect life">

  <link rel="icon" type="image/x-icon" href="assets/img/favicon.png">

  <title>Cankurtaran</title>
  <link rel="stylesheet" href="assets/lib/leaflet/leaflet.css"/>
  <link rel="stylesheet" href="assets/css/app.css">

  <!-- Yeni: arama kutusu stilleri (hafif, sayfaya gömülü) -->
  <style>
    #searchContainer{
      position: absolute;
      top: 10px;
      /* sağda konumlandırmadan ortaya alındı */
      left: 50%;
      right: auto;
      transform: translateX(-50%);
      z-index: 10050; /* leaflet üzeri olacak şekilde yüksek */
      width: 360px;
      max-height: 60vh;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-family: Arial, Helvetica, sans-serif;
      pointer-events: auto; /* tıklamaları alması için */
    }
    #citySearch{
      padding:8px 10px;
      border-radius:4px;
      border:1px solid rgba(0,0,0,0.2);
      outline: none;
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
      background: white;
    }
    #searchResults{
      margin:0;
      padding:0;
      list-style:none;
      overflow:auto;
      background: white;
      border: 1px solid rgba(0,0,0,0.12);
      border-radius:4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      pointer-events: auto;
    }
    #searchResults li{
      padding:8px 10px;
      border-bottom:1px solid rgba(0,0,0,0.05);
      cursor:pointer;
    }
    #searchResults li:hover{
      background:#f3f7f3;
    }
    #searchResults .meta{
      display:block;
      font-size:12px;
      color:#666;
    }
    .search-empty{
      padding:8px 10px;
      color:#666;
    }

    /* Mevcut stil tanımlamalarınızın altına ekleyin */
    .custom-marker-container {
      position: relative;
      display: inline-block;
    }
    .custom-marker-container img {
      display: block;
    }
    .close-marker {
      position: absolute;
      top: -34px;
      right: -3px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      text-align: center;
      line-height: 30px;
      font-size: 26px;
      cursor: pointer;
      z-index: 100;
      text-decoration: none;
      color: #cb6363 !important;
    }
    .close-marker:hover{
      background: #f3e6e6;
      border-color: #999;
    }
  </style>

</head>
<body>
  <div id="container">
    <div id="map"></div>

    <!-- Yeni: arama inputu ve sonuç listesi -->
    <div id="searchContainer" aria-hidden="false">
      <input id="citySearch" type="search" placeholder="Şehir veya ilçe ara..." autocomplete="off" />
      <ul id="searchResults" role="listbox"></ul>
    </div>

  </div>
  <script src="assets/lib/leaflet/leaflet.js"></script>

  <script src="assets/lib/Leaflet.draw-develop/src/Leaflet.draw.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/Leaflet.Draw.Event.js"></script>
  <link rel="stylesheet" href="assets/lib/Leaflet.draw-develop/src/leaflet.draw.css"/>
  <link rel="stylesheet" href="assets/lib/text-label/text-label.css"/>
  <link rel="stylesheet" href="assets/lib/leaflet-gps-control/leaflet-gps-control.css">
  <link rel="stylesheet" href="assets/lib/leaflet-lang/leaflet-lang.css">

  <script src="assets/lib/Leaflet.draw-develop/src/Toolbar.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/Tooltip.js"></script>

  <script src="assets/lib/Leaflet.draw-develop/src/ext/GeometryUtil.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/ext/LatLngUtil.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/ext/LineUtil.Intersect.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/ext/Polygon.Intersect.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/ext/Polyline.Intersect.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/ext/TouchEvents.js"></script>

  <script src="assets/lib/Leaflet.draw-develop/src/draw/DrawToolbar.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/draw/handler/Draw.Feature.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/draw/handler/Draw.SimpleShape.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/draw/handler/Draw.Polyline.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/draw/handler/Draw.Marker.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/draw/handler/Draw.Circle.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/draw/handler/Draw.CircleMarker.js"></script>  
  <script src="assets/lib/Leaflet.draw-develop/src/draw/handler/Draw.Polygon.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/draw/handler/Draw.Rectangle.js"></script>

  <script src="assets/lib/Leaflet.draw-develop/src/edit/EditToolbar.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/edit/handler/EditToolbar.Edit.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/edit/handler/EditToolbar.Delete.js"></script>

  <script src="assets/lib/Leaflet.draw-develop/src/Control.Draw.js"></script>

  <script src="assets/lib/Leaflet.draw-develop/src/edit/handler/Edit.Poly.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/edit/handler/Edit.SimpleShape.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/edit/handler/Edit.Rectangle.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/edit/handler/Edit.Marker.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/edit/handler/Edit.CircleMarker.js"></script>
  <script src="assets/lib/Leaflet.draw-develop/src/edit/handler/Edit.Circle.js"></script>

  <script src="assets/lib/text-label/text-label.js"></script>
  <script src="assets/lib/leaflet-lang/leaflet-lang.js"></script>
  <script src="assets/lib/leaflet-gps-control/leaflet-gps-control.js"></script>
  <script src="assets/js/app.js"></script>
  <script src="assets/lib/FileSaver.js/dist/FileSaver.min.js"></script>


<script>
    var map = L.map('map', {zoomControl: false,worldCopyJump: true}).setView([40.908263,29.056295], 5);

    // Mevcut uydu katmanı (koruyorum)
    var esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '<a href="https://github.com/aliyilmaz/cankurtaran">Project page</a>'
    }).addTo(map);

    // Sokak haritası (OpenStreetMap)
    var street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    });

    // EMODnet (bathymetry) tiles - gerektiğinde URL'yi güncelleyebilirsiniz
    var emodnet = L.tileLayer('https://tiles.emodnet-bathymetry.eu/2020/baselayer/web_mercator/{z}/{x}/{y}.png', {
      maxZoom: 12,
      attribution: 'EMODnet'
    });

    var nautical = L.tileLayer('https://tiles.c-map.com/wmts/cmt_int1/webmercator/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Nautical Charts'
    });

    // Base map kontrolü
    var baseMaps = {
      "Satellite (Esri)": esriSat,
      "Street (OSM)": street,
      "EMODnet": emodnet,
      "Nautical Charts": nautical
    };
    L.control.layers(baseMaps, null, { position: 'bottomright', collapsed: false }).addTo(map);

    // Küçük ölçek göstergesi
    L.control.scale({ position: 'bottomleft' }).addTo(map);

    let title;
    if(lang == 'tr'){
      title = 'Konum Takibi';
    }
    L.control.gpsLocation({ position: 'topleft',title:title }).addTo(map);
    
    const Label = L.control.addText({position: 'topleft', status:true});
    if(Label.layer != undefined) Label.layer.addTo(map);

    const shapeoption = {
      color: '#45b165',
      fillColor: '#3ebf37',
      fillOpacity: 0.4,
      weight: 2
    };
    let options = {
      position:'topleft',
      // draw:{
        // circle:false,
        // circlemarker:false,
        // polygon: false,
        // marker: false,
        // rectangle: false,
        // polyline:false
      // },
      draw: {
        circle:{          
          shapeOptions: shapeoption,
          repeatMode: false
        },
        circlemarker:{                  
          color: '#3ebf37',    
          weight: 12,        
          fillOpacity: 1,  
          repeatMode: true
        },        
        polygon: {     
          shapeOptions: shapeoption,
          metric: true,
          showLength: true,
          guidelineDistance:15
        },
        marker: {
          repeatMode: true
        },
        rectangle: {          
          shapeOptions: shapeoption,          
          repeatMode: false        
        },
        polyline: {          
          shapeOptions: {
              color: '#3ebf37',
              weight: 2              
          },          
          guidelineDistance:15,
          repeatMode: false        
        }
        
        
      }

    };

    let localOption={
        draw: {
          toolbar: {
            actions: {
              title: 'Çizimi İptal Et',
              text: 'İptal'
            },
            finish: {
              title: 'Çizimi Tamamla',
              text: 'Tamamla'
            },
            undo: {
              title: 'Son Adımı Geri Al',
              text: 'Geri Al'
            },
            buttons: {
              polyline: 'Çizgi Çiz',
              polygon: 'Çokgen Çiz',
              rectangle: 'Dikdörtgen Çiz',
              circle: 'Daire Çiz',
              marker: 'Nokta İşaretle',
              circlemarker: 'Daire İşaretle'
            }
          },
          handlers: {
            circle: {
              tooltip: {
                start: 'Çizim için tıklayın.'
              },
              radius: 'Yarıçap'
            },
            circlemarker: {
              tooltip: {
                start: 'İşaretleme için tıklayın.'
              }
            },
            marker: {
              tooltip: {
                start: 'İşaretlemek için tıklayın.'
              }
            },
            polygon: {
              tooltip: {
                start: 'Çizime başlamak için tıklayın.',
                cont: 'Devam etmek için tıklayın.',
                end: 'Bitirmek için son noktaya tıklayın.'
              }
            },
            polyline: {
              error: '<strong>Hata:</strong> şekil kenarları kesişemez!',
              tooltip: {
                start: 'Çizgi çizmeye başlamak için tıklayın.',
                cont: 'Çizmeye devam etmek için tıklayın.',
                end: 'Çizimi bitirmek için son noktaya tıklayın.'
              }
            },
            rectangle: {
              tooltip: {
                start: 'Dikdörtgen çizmek için tıklayın.'
              }
            },
            simpleshape: {
              tooltip: {
                end: 'Çizimi bitirmek için fareyi bırakın.'
              }
            }
          }
        },
        edit: {
          toolbar: {
            actions: {
              save: {
                title: 'Değişiklikleri Kaydet',
                text: 'Kaydet'
              },
              cancel: {
                title: 'Düzenlemeleri İptal Et, Tüm Değişiklikleri İptal Et',
                text: 'İptal'
              },
              clearAll: {
                title: 'Tüm Katmanları Temizle',
                text: 'Hepsini Temizle'
              }
            },
            buttons: {
              edit: 'Katmanları Düzenle',
              editDisabled: 'Düzenlenecek Katman Yok',
              remove: 'Katmanları Sil',
              removeDisabled: 'Silinecek Katman Yok'
            }
          },
          handlers: {
            edit: {
              tooltip: {
                text: 'Özellikleri düzenlemek için tutmaçları veya işaretçileri sürükleyin.',
                subtext: 'Değişiklikleri geri almak için iptale tıklayın.'
              }
            },
            remove: {
              tooltip: {
                text: 'Bir özelliği kaldırmak için üzerine tıklayın.'
              }
            }
          }
        }        
      };      
    let exportOption = {
      button: {
        status: true,
        text: "İndir",
        title: "GEOJSON dosyasını indir",
        svgicon: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 384 512'><path d='M64 464c-8.8 0-16-7.2-16-16L48 64c0-8.8 7.2-16 16-16l160 0 0 80c0 17.7 14.3 32 32 32l80 0 0 288c0 8.8-7.2 16-16 16L64 464zM64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-293.5c0-17-6.7-33.3-18.7-45.3L274.7 18.7C262.7 6.7 246.5 0 229.5 0L64 0zm97 289c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0L79 303c-9.4 9.4-9.4 24.6 0 33.9l48 48c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-31-31 31-31zM257 255c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l31 31-31 31c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l48-48c9.4-9.4 9.4-24.6 0-33.9l-48-48z'/></svg>"
      }
    };
    let importOption = {
      button: {
        status: true,
        text: "Yükle",
        title: "GEOJSON dosyasını yükle",
        svgicon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-288-128 0c-17.7 0-32-14.3-32-32L224 0 64 0zM256 0l0 128 128 0L256 0zM216 408c0 13.3-10.7 24-24 24s-24-10.7-24-24l0-102.1-31 31c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l72-72c9.4-9.4 24.6-9.4 33.9 0l72 72c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-31-31L216 408z"/></svg>'
      }
    };

    if(lang == 'tr'){
      options.local = localOption;
      options.export = exportOption;
      options.import = importOption;
    }
    
    var drawMapPlugin = L.drawMapPlugin(options);
    drawMapPlugin.addTo(map);

    // Yeni: cities.json içinden anlık (live) arama işlevi
    (function(){
      const input = document.getElementById('citySearch');
      const resultsEl = document.getElementById('searchResults');
      let cities = [];
      let marker = null;
      let debounceTimer = null;
      
      // Küçük yardımcı: koordinat anahtarlarını tespit et
      function getCoords(item){
        const latKeys = ['lat','latitude','y'];
        const lngKeys = ['lng','lon','longitude','x'];
        let lat, lng;
        for(const k of latKeys){
          if(item[k] !== undefined){ lat = parseFloat(item[k]); break; }
        }
        for(const k of lngKeys){
          if(item[k] !== undefined){ lng = parseFloat(item[k]); break; }
        }
        if(Number.isFinite(lat) && Number.isFinite(lng)) return [lat, lng];
        return null;
      }
      
      // Özel marker icon oluşturma fonksiyonu
      function createCustomMarkerIcon() {
        return L.divIcon({
          className: '', // ekstra stil eklemeye gerek yok
          html: `<div class="custom-marker-container">
                   <a class="close-marker" href="#">×</a>
                   <img src="assets/lib/leaflet/images/marker-icon.png" alt="marker icon"/>
                 </div>`,
          iconSize: [25, 41],
          iconAnchor: [12, 41]
        });
      }
      
      // Sonuçları göster
      function renderResults(list){
        resultsEl.innerHTML = '';
        if(!list.length){
          // Sadece input boş değilse uyarı göster
          if(input.value.trim() !== ""){
            const li = document.createElement('li');
            li.className = 'search-empty';
            li.textContent = 'Sonuç bulunamadı';
            resultsEl.appendChild(li);
          }
          return;
        }
        list.slice(0, 20).forEach(item=>{
          const li = document.createElement('li');
          const title = item.name || item.city || 'İsimsiz';
          const state = item.state_name || item.state || '';
          li.innerHTML = '<strong>'+title+'</strong>' + (state ? (' <span class="meta"> / '+state+'</span>') : '');
          li.addEventListener('click', ()=>{
            const coords = getCoords(item);
            if(coords){
              // Önceki marker varsa kaldır
              if(marker){
                map.removeLayer(marker);
                marker = null;
              }
              // Yeni marker oluştur (özelleştirilmiş icon ile)
              marker = L.marker(coords, { icon: createCustomMarkerIcon() }).addTo(map);
              map.setView(coords, 12);
              
              // Kısa süre sonra marker element yüklendiğinde, close butonunu etkinleştir
              setTimeout(()=>{
                const markerEl = marker.getElement();
                if(markerEl){
                  const closeBtn = markerEl.querySelector('.close-marker');
                  if(closeBtn){
                    closeBtn.addEventListener('click', function(e){
                      e.preventDefault();
                      map.removeLayer(marker);
                      marker = null;
                    });
                  }
                }
              }, 50);
            }
            // Seçince arama sonuçlarını temizle
            resultsEl.innerHTML = '';
            input.value = title + (state ? (' / ' + state) : '');
          });
          resultsEl.appendChild(li);
        });
      }
      
      // Debounce wrapper
      function onInput(){
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(()=> filterCities(input.value), 220);
      }
      
      // Filtreleme: name veya state_name anahtarlarında ara (case-insensitive)
      function filterCities(q){
        if(!q || q.trim().length < 1){
          renderResults([]);
          return;
        }
        const term = q.trim().toLowerCase();
    
        // normalize: diakritik işaretleri kaldır, küçük harfe çevir
        function normalize(s){
          try{
            return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
          }catch(e){
            return String(s).toLowerCase();
          }
        }
    
        const termNorm = normalize(term);
    
        // Her bir şehir objesindeki tüm string/number alanlarını birleştir ve içinde arama yap
        const matches = cities.filter(item=>{
          if(!item) return false;
          const parts = [];
          for(const k in item){
            if(!Object.prototype.hasOwnProperty.call(item, k)) continue;
            const v = item[k];
            if(typeof v === 'string' || typeof v === 'number'){
              parts.push(v);
            } else if(Array.isArray(v)){
              parts.push(v.filter(x => typeof x === 'string' || typeof x === 'number').join(' '));
            }
          }
          const haystack = normalize(parts.join(' '));
          return haystack.indexOf(termNorm) !== -1;
        });
    
        matches.sort((a,b)=>{
          const aStr = normalize(Object.values(a).filter(v=> typeof v==='string' || typeof v==='number').join(' '));
          const bStr = normalize(Object.values(b).filter(v=> typeof v==='string' || typeof v==='number').join(' '));
          const ai = aStr.indexOf(termNorm);
          const bi = bStr.indexOf(termNorm);
          return (ai === -1 ? 9999 : ai) - (bi === -1 ? 9999 : bi);
        });
    
        renderResults(matches);
      }
      
      // Fetch cities.json (bir kez)
      fetch('assets/cities.json').then(r=>{
        if(!r.ok) throw new Error('cities.json yüklenemedi');
        return r.json();
      }).then(data=>{
        if(Array.isArray(data)) cities = data;
        else if(data && data.cities && Array.isArray(data.cities)) cities = data.cities;
        else {
          try{
            cities = JSON.parse(JSON.stringify(data));
            if(!Array.isArray(cities)) cities = [];
          }catch(e){
            cities = [];
          }
        }
      }).catch(err=>{
        console.warn('cities.json yükleme hatası:', err);
      });
      
      input.addEventListener('input', onInput);
      
      // Klavye ile gezinme (temel)
      input.addEventListener('keydown', function(e){
        const items = Array.from(resultsEl.querySelectorAll('li'));
        if(!items.length) return;
        let idx = items.findIndex(it => it.classList.contains('focused'));
        if(e.key === 'ArrowDown'){
          e.preventDefault();
          idx = Math.min(items.length-1, (idx < 0 ? 0 : idx+1));
          items.forEach(i=>i.classList.remove('focused'));
          items[idx].classList.add('focused');
          items[idx].scrollIntoView({block:'nearest'});
        }
        if(e.key === 'ArrowUp'){
          e.preventDefault();
          idx = Math.max(0, (idx <= 0 ? 0 : idx-1));
          items.forEach(i=>i.classList.remove('focused'));
          items[idx].classList.add('focused');
          items[idx].scrollIntoView({block:'nearest'});
        }
        if(e.key === 'Enter'){
          e.preventDefault();
          const focused = resultsEl.querySelector('li.focused');
          if(focused) focused.click();
        }
      });
      
      // Tıklama dışı kaydırma sorununu önlemek için
      setTimeout(()=>{
        input.addEventListener('mousedown', function(e){
          e.stopPropagation();
        });
        input.addEventListener('touchstart', function(e){
          e.stopPropagation();
        }, {passive:true});
      }, 500);
      
    })();

  </script>

</body>
</html>